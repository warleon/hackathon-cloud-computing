service: websocket-api

provider:
  name: aws
  runtime: python3.11
  region: us-east-1
  stage: ${opt:stage, 'dev'}

  # Tu rol fijo del laboratorio  
  iam:
    role: arn:aws:iam::536437847708:role/LabRole

  environment:
    WEBSOCKETS_TABLE: ${self:custom.tables.websockets}
    USERS_TABLE: ${cf:auth-api-${sls:stage}.auth-UsersTable}
    INCIDENTS_TABLE: ${cf:auth-api-${sls:stage}.auth-IncidentsTable}
    TOKENS_TABLE: ${cf:auth-api-${sls:stage}.auth-TokensTable}
    API_GATEWAY_ENDPOINT:
      Fn::Join:
        - ""
        - - https://
          - Ref: WebsocketApi
          - .execute-api.${self:provider.region}.amazonaws.com/${sls:stage}

custom:
  tables:
    websockets: ${self:service}-connections-${sls:stage}

functions:
  onConnect:
    handler: onConnect.handler
    events:
      - websocket:
          route: $connect

  onDisconnect:
    handler: onDisconnect.handler
    events:
      - websocket:
          route: $disconnect

  notify:
    handler: notify.handler
    events:
      - stream:
          type: dynamodb
          arn: ${cf:auth-api-${sls:stage}.auth-IncidentsTableStreamArn}
          batchSize: 10
          startingPosition: LATEST

resources:
  Resources:

    # === Crear API Websocket ===
    WebsocketApi:
      Type: AWS::ApiGatewayV2::Api
      Properties:
        Name: websocket-api
        ProtocolType: WEBSOCKET
        RouteSelectionExpression: "$request.body.action"

    # === Crear Stage ===
    WebsocketApiStage:
      Type: AWS::ApiGatewayV2::Stage
      Properties:
        StageName: ${sls:stage}
        ApiId:
          Ref: WebsocketApi
        AutoDeploy: true

    # === Integraciones ===
    ConnectIntegration:
      Type: AWS::ApiGatewayV2::Integration
      Properties:
        ApiId: { Ref: WebsocketApi }
        IntegrationType: AWS_PROXY
        IntegrationUri:
          Fn::GetAtt: [OnConnectLambdaFunction, Arn]

    DisconnectIntegration:
      Type: AWS::ApiGatewayV2::Integration
      Properties:
        ApiId: { Ref: WebsocketApi }
        IntegrationType: AWS_PROXY
        IntegrationUri:
          Fn::GetAtt: [OnDisconnectLambdaFunction, Arn]

    # === Rutas ===
    ConnectRoute:
      Type: AWS::ApiGatewayV2::Route
      Properties:
        ApiId: { Ref: WebsocketApi }
        RouteKey: $connect
        AuthorizationType: NONE
        Target:
          Fn::Join:
            - /
            - - integrations
              - Ref: ConnectIntegration

    DisconnectRoute:
      Type: AWS::ApiGatewayV2::Route
      Properties:
        ApiId: { Ref: WebsocketApi }
        RouteKey: $disconnect
        AuthorizationType: NONE
        Target:
          Fn::Join:
            - /
            - - integrations
              - Ref: DisconnectIntegration

    # === Permisos Lambda â†’ API Gateway ===
    OnConnectPermission:
      Type: AWS::Lambda::Permission
      Properties:
        FunctionName: ${self:service}-${sls:stage}-onConnect
        Action: lambda:InvokeFunction
        Principal: apigateway.amazonaws.com

    OnDisconnectPermission:
      Type: AWS::Lambda::Permission
      Properties:
        FunctionName: ${self:service}-${sls:stage}-onDisconnect
        Action: lambda:InvokeFunction
        Principal: apigateway.amazonaws.com

    # === Tabla DynamoDB ===
    WebsocketsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.tables.websockets}
        AttributeDefinitions:
          - AttributeName: connectionId
            AttributeType: S
        KeySchema:
          - AttributeName: connectionId
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST

  Outputs:
    WebsocketUrl:
      Value:
        Fn::Join:
          - ""
          - - wss://
            - Ref: WebsocketApi
            - .execute-api.${self:provider.region}.amazonaws.com/${sls:stage}
